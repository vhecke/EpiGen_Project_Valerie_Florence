---
title: "Project_2.2_Histone_Modifications_BG_"
author: "Florence Marti"
date: "2025-06-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("~/Documents/GitHub/EpiGen_Project_Valerie_Florence/Histone Modifications Memory")
```

```{r, include = FALSE}
suppressPackageStartupMessages({
  library(AnnotationHub)
  library(ensembldb)
  library(GenomicRanges)
  library(epiwraps)
  library(rtracklayer)
  library(ggplot2)
  library(magick)
  library(R.utils) 
  library(MASS)
  library(org.Mm.eg.db)
  library(AnnotationDbi)
  library(valr)
  library(EnrichedHeatmap)
  library(gridExtra)
  library(grid)
  library(limma)
  library(plyranges)
})
```

# Importing the downloaded data

```{r}
head(read.table("peaks/H3K27ac.txt", header = TRUE))
```

```{r}
CTCF_df <- read.table("peaks/CTCF.txt", header = TRUE)
H3K27ac_df <- read.table("peaks/H3K27ac.txt", header = TRUE)
H3K27me3_df <- read.table("peaks/H3K27me3.txt", header = TRUE)
H3K4me3_df <- read.table("peaks/H3K4me3.txt", header = TRUE)
H3K9me3_df <- read.table("peaks/H3K9me3.txt", header = TRUE)

# GRanges
CTCF_gr <- GRanges(seqnames = CTCF_df$Chr, ranges = IRanges(start = CTCF_df$Start, end = CTCF_df$End))
H3K27ac_gr <- GRanges(seqnames = H3K27ac_df$Chr, ranges = IRanges(start = H3K27ac_df$Start, end = H3K27ac_df$End))
H3K27me3_gr <- GRanges(seqnames = H3K27me3_df$Chr, ranges = IRanges(start = H3K27me3_df$Start, end = H3K27me3_df$End))
H3K4me3_gr <- GRanges(seqnames = H3K4me3_df$Chr, ranges = IRanges(start = H3K4me3_df$Start, end = H3K4me3_df$End))
H3K9me3_gr <- GRanges(seqnames = H3K9me3_df$Chr, ranges = IRanges(start = H3K9me3_df$Start, end = H3K9me3_df$End))


peaks <- GRangesList(
  CTCF = CTCF_gr,
  H3K27ac = H3K27ac_gr,
  H3K27me3 = H3K27me3_gr,
  H3K4me3 = H3K4me3_gr,
  H3K9me3 = H3K9me3_gr
)

dir.create("peak_bed_files")
rtracklayer::export(peaks$CTCF, "peak_bed_files/CTCF_peaks.bed")
rtracklayer::export(peaks$H3K27ac, "peak_bed_files/H3K27ac_peaks.bed")
rtracklayer::export(peaks$H3K27me3, "peak_bed_files/H3K27me3_peaks.bed")
rtracklayer::export(peaks$H3K4me3, "peak_bed_files/H3K4me3_peaks.bed")
rtracklayer::export(peaks$H3K9me3, "peak_bed_files/H3K9me3_peaks.bed")

```

```{r, fig.cap="Figure 1. UpSet plot showing the overlap of genomic regions (peaks) identified for each histone modification (H3K4me3, H3K27ac, H3K27me3, H3K9me3) in naive and memory T cells. This visualization highlights the extent of shared and unique chromatin regions across hPMTs."}
regionUpset(peaks)
```
In this upset plot we show that while we have a lot of single hits, we also have 7611 bivalent regions for H3K27me3, and H3K4me3. 


# Quality Control

## PCA

```{r}
H3K27ac_PCA <- H3K27ac_df[,7:22]
rownames(H3K27ac_PCA) <- H3K27ac_df$peakN

H3K4me3_PCA <- H3K4me3_df[,7:22]
rownames(H3K4me3_PCA) <- H3K4me3_df$peakN

H3K27me3_PCA <- H3K27me3_df[,7:22]
rownames(H3K27me3_PCA) <- H3K27me3_df$peakN

H3K9me3_PCA <- H3K9me3_df[,7:22]
rownames(H3K9me3_PCA) <- H3K9me3_df$peakN


```

```{r}
run_pca <- function(signal_matrix, mark_name) {
  # Transpose: rows = samples, columns = peaks
  pca_input <- t(signal_matrix)
  
  # Run PCA (scale = TRUE for z-scoring)
  pca_result <- prcomp(pca_input, scale. = TRUE)
  
  # Variance explained by PCs
  variance <- summary(pca_result)$importance[2, ]
  
  # Plot PCA
  pca_df <- data.frame(
    PC1 = pca_result$x[, 1],
    PC2 = pca_result$x[, 2],
    CellType = rep(c("Naive_30", "Naive_32", "Memory", "Exhausted"), each = 4)
  )
  
  ggplot(pca_df, aes(PC1, PC2, color = CellType)) +
  geom_point(size = 4,) +
  scale_color_manual(values = c("Naive_30" = "#ef77b4", "Naive_32"= "#4daf4a", "Memory" = "#ff7f0e", "Exhausted" = "#a6cee3" )) +
    labs(
      title = paste("PCA of", mark_name, "Signal"),
      x = paste0("PC1 (", round(variance[1]*100, 1), "%)"),
      y = paste0("PC2 (", round(variance[2]*100, 1), "%)")
    ) +
  theme_classic()
}

plot_H3K27ac <- run_pca(H3K27ac_PCA, "H3K27ac")
plot_H3K4me3 <- run_pca(H3K4me3_PCA, "H3K4me3")
plot_H3K27me3 <- run_pca(H3K27me3_PCA, "H3K27me3")
plot_H3K9me3 <- run_pca(H3K9me3_PCA, "H3K9me3")
```

```{r}
library(gridExtra)
grid.arrange(
  plot_H3K27ac, plot_H3K4me3,
  plot_H3K27me3, plot_H3K9me3,
  nrow = 2,
  top = "PCA of hPMTs in Naive vs. Memory T Cells"
)
```
```{r}
# Convert row names to a column named "peakID" in each data frame
H3K27ac_PCA <- H3K27ac_PCA %>% tibble::rownames_to_column("peakID")
H3K4me3_PCA <- H3K4me3_PCA %>% tibble::rownames_to_column("peakID")
H3K27me3_PCA <- H3K27me3_PCA %>% tibble::rownames_to_column("peakID")
H3K9me3_PCA <- H3K9me3_PCA %>% tibble::rownames_to_column("peakID")

library(dplyr)

combined_signals <- list(
  H3K27ac_PCA,
  H3K4me3_PCA,
  H3K27me3_PCA,
  H3K9me3_PCA
) %>% 
  Reduce(function(x, y) inner_join(x, y, by = "peakID"), .)

rownames(combined_signals) <- combined_signals$peakID
combined_signals$peakID <- NULL

dim(combined_signals)

```
```{r}
# Assuming combined_signals is your merged matrix (samples x features)
pca_input <- t(combined_signals)  # Transpose for PCA (rows = samples)

# Run PCA
pca_result <- prcomp(pca_input, scale. = TRUE)

# Create annotation data frame
annotation_col <- data.frame(
  CellType = rep(rep(c("Naive_30", "Naive_32", "Memory", "Exhausted"), each = 4), times = 4),
  HistoneMark = rep(c("H3K4me3", "H3K27ac", "H3K27me3", "H3K9me3"), each = 16)
)
rownames(annotation_col) <- colnames(combined_signals)

# Combine PCA results with annotations
pca_df <- data.frame(
  PC1 = pca_result$x[, 1],
  PC2 = pca_result$x[, 2],
  CellType = annotation_col$CellType,
  HistoneMark = annotation_col$HistoneMark
)

# Plot with custom aesthetics
library(ggplot2)
ggplot(pca_df, aes(PC1, PC2, color = CellType, shape = HistoneMark)) +
  geom_point(size = 4, alpha = 0.8) +
  scale_color_manual(values = c("Naive_30" = "#ef77b4", "Naive_32"= "#4daf4a", "Memory" = "#ff7f0e", "Exhausted" = "#a6cee3" )) +
  scale_shape_manual(values = c(16, 17, 15, 18)) +  # Different shapes for marks
  theme_classic() +
  labs(
    title = "PCA of hPMTs in T Cells",
    x = paste0("PC1 (", round(summary(pca_result)$importance[2,1]*100, 1), "%)"),
    y = paste0("PC2 (", round(summary(pca_result)$importance[2,2]*100, 1), "%)")
  ) +
  guides(color = guide_legend(order = 1), shape = guide_legend(order = 2))

```


# Signal Extraction and Filtering
Signal intensities for naive and memory T cells were extracted, and mean values per group were calculated for each peak. We extracted the signal values from the GRanges files for each histone modification and cell type and then computed log2 fold changes and filtered for regions with significant differences (absolute log2(signal) > 0.58496), focusing on biologically relevant changes in chromatin accessibility.

```{r}
# Naive = cols 7:10, Memory = cols 15:18
H3K27ac_signal <- cbind(
  naive = H3K27ac_df[, 7:10],
  memory = H3K27ac_df[, 15:18],
  exh = H3K27ac_df[, 19:22]
)
H3K27me3_signal <- cbind(
  naive = H3K27me3_df[, 7:10],
  memory = H3K27me3_df[, 15:18],
  exh = H3K27me3_df[, 19:22]
)
H3K4me3_signal <- cbind(
  naive = H3K4me3_df[, 7:10],
  memory = H3K4me3_df[, 15:18],
  exh = H3K4me3_df[, 19:22]
)

H3K9me3_signal <- cbind(
  naive = H3K9me3_df[, 7:10],
  memory = H3K9me3_df[, 15:18],
  exh = H3K9me3_df[, 19:22]
)


rownames(H3K27ac_signal) <- paste(H3K27ac_df$peakN)
rownames(H3K27me3_signal) <- paste(H3K27me3_df$peakN)
rownames(H3K4me3_signal)  <- paste(H3K4me3_df$peakN)
rownames(H3K9me3_signal)  <- paste(H3K9me3_df$peakN)
```



# H3K4me3
```{r}
mean_naive_H3K4me3 <- rowMeans(H3K4me3_signal[, 1:4])   
mean_memory_H3K4me3 <- rowMeans(H3K4me3_signal[, 5:8])  
mean_exh_H3K4me3 <- rowMeans(H3K4me3_signal[, 9:12])  

pseudocount <- 1e-6
log2_H3K4me3 <- log2((mean_memory_H3K4me3 + pseudocount) / (mean_naive_H3K4me3 + pseudocount))


sig_rows_H3K4me3 <- which(abs(log2_H3K4me3) > 0.58496)


sig_H3K4me3_signal <- H3K4me3_signal[sig_rows_H3K4me3, 1:8]


scaled_signal_H3K4me3 <- t(scale(t(sig_H3K4me3_signal)))  

```

# H3K27ac
```{r}

mean_naive_H3K27ac <- rowMeans(H3K27ac_signal[, 1:4])  
mean_memory_H3K27ac <- rowMeans(H3K27ac_signal[, 5:8])  
mean_exh_H3K27ac <- rowMeans(H3K27ac_signal[, 9:12])  

log2_H3K27ac <- log2((mean_memory_H3K27ac + pseudocount) / (mean_naive_H3K27ac + pseudocount))


sig_rows_H3K27ac <- which(abs(log2_H3K27ac) > 0.58496)


sig_H3K27ac_signal <- H3K27ac_signal[sig_rows_H3K27ac,1:8 ]

# Scale the signal matrix for plotting
scaled_signal_H3K27ac <- t(scale(t(sig_H3K27ac_signal)))  


```

# H3K27me3
```{r}
mean_naive_H3K27me3 <- rowMeans(H3K27me3_signal[, 1:4])   
mean_memory_H3K27me3 <- rowMeans(H3K27me3_signal[, 5:8]) 
mean_exh_H3K27me3 <- rowMeans(H3K27me3_signal[, 9:12])  

log2_H3K27me3 <- log2((mean_memory_H3K27me3 + pseudocount) / (mean_naive_H3K27me3 + pseudocount))


sig_rows_H3K27me3 <- which(abs(log2_H3K27me3) > 0.58496)

sig_H3K27me3_signal <- H3K27me3_signal[sig_rows_H3K27me3,1:8 ]

scaled_signal_H3K27me3 <- t(scale(t(sig_H3K27me3_signal)))  

```

# H3K9me3
```{r}
mean_naive_H3K9me3 <- rowMeans(H3K9me3_signal[, 1:4])   
mean_memory_H3K9me3 <- rowMeans(H3K9me3_signal[, 5:8]) 
mean_exh_H3K9me3 <- rowMeans(H3K9me3_signal[, 9:12])  

log2_H3K9me3 <- log2((mean_memory_H3K9me3 + pseudocount) / (mean_naive_H3K9me3 + pseudocount))


sig_rows_H3K9me3 <- which(abs(log2_H3K9me3) > 0.58496)

sig_H3K9me3_signal <- H3K9me3_signal[sig_rows_H3K9me3,1:8 ]

scaled_signal_H3K9me3 <- t(scale(t(sig_H3K9me3_signal)))  
```

## Comparing memory and exhausted cells:
# H3K4me3
```{r}
log2_H3K4me3_exh_me<- log2((mean_exh_H3K4me3 + pseudocount) / (mean_memory_H3K4me3 + pseudocount))

sig_rows_H3K4me3_exh_me<- which(abs(log2_H3K4me3_exh_me) > 0.58496)

sig_H3K4me3_signal_exh_me<- H3K4me3_signal[sig_rows_H3K4me3_exh_me,5:12 ]

scaled_signal_H3K4me3_exh_me<- t(scale(t(sig_H3K4me3_signal_exh_me)))  

```

# H3K27ac
```{r}
log2_H3K27ac_exh_me<- log2((mean_exh_H3K27ac + pseudocount) / (mean_memory_H3K27ac + pseudocount))


sig_rows_H3K27ac_exh_me<- which(abs(log2_H3K27ac_exh_me) > 0.58496)


sig_H3K27ac_signal_exh_me<- H3K27ac_signal[sig_rows_H3K27ac, 5:12]

scaled_signal_H3K27ac_exh_me<- t(scale(t(sig_H3K27ac_signal_exh_me)))  


```

# H3K27me3
```{r}
log2_H3K27me3_exh_me<- log2((mean_exh_H3K27me3 + pseudocount) / (mean_memory_H3K27me3 + pseudocount))


sig_rows_H3K27me3_exh_me<- which(abs(log2_H3K27me3_exh_me) > 0.58496)

sig_H3K27me3_signal_exh_me<- H3K27me3_signal[sig_rows_H3K27me3_exh_me,5:12 ]

scaled_signal_H3K27me3_exh_me<- t(scale(t(sig_H3K27me3_signal_exh_me)))  

```

# H3K9me3
```{r}
log2_H3K9me3_exh_me<- log2((mean_exh_H3K9me3 + pseudocount) / (mean_memory_H3K9me3 + pseudocount))


sig_rows_H3K9me3_exh_me<- which(abs(log2_H3K9me3_exh_me) > 0.58496)

sig_H3K9me3_signal_exh_me <- H3K9me3_signal[sig_rows_H3K9me3_exh_me, 5:12]

scaled_signal_H3K9me3_exh_me<- t(scale(t(sig_H3K9me3_signal_exh_me)))  
```


```{r, eval = T, include = F}
rm(mean_memory_H3K27ac, mean_naive_H3K27ac, mean_memory_H3K27me3, mean_memory_H3K4me3, mean_memory_H3K9me3, mean_naive_H3K27me3, mean_naive_H3K4me3, mean_naive_H3K9me3, sig_rows_H3K27ac, sig_rows_H3K27me3, sig_rows_H3K4me3, sig_rows_H3K9me3, sig_H3K27ac_signal, sig_H3K27me3_signal,sig_H3K4me3_signal, sig_H3K9me3_signal, log2_H3K27ac, log2_H3K27me3, log2_H3K4me3, log2_H3K9me3, sig_H3K9me3_signal_exh_me, sig_rows_H3K9me3_exh_me, sig_H3K27me3_signal_exh_me, sig_rows_H3K27me3_exh_me, sig_H3K27ac_signal_exh_me, sig_rows_H3K27ac_exh_me, sig_H3K4me3_signal_exh_me, sig_rows_H3K4me3_exh_me, sig_H3K9me3_signal, sig_rows_H3K9me3, sig_H3K27me3_signal, sig_rows_H3K27me3, sig_H3K27ac_signal, sig_rows_H3K27ac, sig_rows_H3K4me3, sig_H3K4me3_signal)
```

# Visualisation of heatmaps for memory vs naive
```{r}
# Suppose you have 4 naive and 4 memory samples per histone mark
annotation_col <- data.frame(
  CellType = rep(c("Naive T-Cell", "Memory T-Cell"), each = 4)
)

annotation_colors <- list(
  CellType = c("Naive T-Cell" = "#ef77b4", "Memory T-Cell" = "#ff7f0e"))

my_breaks <- seq(-2, 2, length.out = 50)

rownames(annotation_col) <- colnames(scaled_signal_H3K4me3)  

hmap1 <- pheatmap::pheatmap(scaled_signal_H3K4me3, annotation_col = annotation_col, annotation_colors = annotation_colors, show_colnames = FALSE, show_rownames = FALSE, main = "H3K4me3" ,silent = TRUE)



rownames(annotation_col) <- colnames(scaled_signal_H3K27ac)  

hmap2 <- pheatmap::pheatmap(scaled_signal_H3K27ac, annotation_col = annotation_col, annotation_colors = annotation_colors,show_colnames = FALSE, show_rownames = FALSE, main = "H3K27ac", silent = TRUE)


rownames(annotation_col) <- colnames(scaled_signal_H3K27me3)  
hmap3 <- pheatmap::pheatmap(scaled_signal_H3K27me3, annotation_col = annotation_col, annotation_colors = annotation_colors,show_colnames = FALSE, show_rownames = FALSE, main = "H3K27me3", silent = TRUE)

rownames(annotation_col) <- colnames(scaled_signal_H3K9me3)  
hmap4 <- pheatmap::pheatmap(scaled_signal_H3K9me3, annotation_col = annotation_col, annotation_colors = annotation_colors, show_colnames = FALSE, show_rownames = FALSE, main = "H3K9me3", silent = TRUE)
```


```{r, fig.align='center',fig.cap="Figure 2. Heatmaps of z-scored signal intensities for significantly different peaks in each histone modification. Each heatmap displays naive and memory T cell samples, with hierarchical clustering of regions. Color scale represents scaled signal intensity (blue: low, yellow: intermediate, red: high", fig.height=10, fig.width= 5}
# Arrange in 2x2 grid (activating on top, suppressing on bottom)
grid.arrange(
  hmap2$gtable, hmap1$gtable,
  hmap3$gtable, hmap4$gtable,
  nrow = 4,
  top = "Histone Modification Profiles in T$_{Mem}$ vs T$_{Exh}$"
)


```


```{r}
# List of all scaled matrices
scaled_list <- list(scaled_signal_H3K4me3, scaled_signal_H3K27ac, scaled_signal_H3K27me3, scaled_signal_H3K9me3)

rm(scaled_signal_H3K4me3, scaled_signal_H3K27ac, scaled_signal_H3K27me3, scaled_signal_H3K9me3)

# Get union of all rownames (regions)
all_regions <- Reduce(union, lapply(scaled_list, rownames))

# Function to add missing rows with zeros and reorder rows by all_regions
fill_missing_rows <- function(mat, all_rows) {
  missing <- setdiff(all_rows, rownames(mat))
  if(length(missing) > 0) {
    # Create zero matrix for missing rows
    zero_mat <- matrix(0, nrow = length(missing), ncol = ncol(mat),
                       dimnames = list(missing, colnames(mat)))
    # Bind existing matrix and zero rows
    mat <- rbind(mat, zero_mat)
  }
  # Reorder rows
  mat[all_rows, , drop = FALSE]
}

# Apply function to each scaled matrix
scaled_filled <- lapply(scaled_list, fill_missing_rows, all_rows = all_regions)

# Combine all columns together (all samples from all histone mods)
combined_scaled <- do.call(cbind, scaled_filled)

rm(scaled_list)
```

```{r}
# Get colnames for each scaled matrix (samples)
samples_H3K4me3  <- colnames(scaled_filled[[1]])
samples_H3K27ac  <- colnames(scaled_filled[[2]])
samples_H3K27me3 <- colnames(scaled_filled[[3]])
samples_H3K9me3  <- colnames(scaled_filled[[4]])

all_samples <- c (samples_H3K27ac, samples_H3K4me3, samples_H3K27me3, samples_H3K9me3)


# Assuming 4 naive + 4 memory per histone modification, adjust if different
annotation_col <- data.frame(
  CellType = rep(c("Naive T-Cell", "Memory T-Cell"), times = c(4,4)),
  HistoneMark = rep(c( "H3K27ac", "H3K4me3", "H3K27me3", "H3K9me3"), each = 8),
  Modification = rep(c("Activating", "Repressing"), each = 16)
)

annotation_colors <- list(
  CellType = c("Naive T-Cell" = "#ef77b4", "Memory T-Cell" = "#ff7f0e"),
  HistoneMark = c(
    "H3K4me3" = "#4daf4a",
    "H3K27ac" = "#377eb8",
    "H3K27me3" = "#e41a1c",
    "H3K9me3" = "#984ea3"
  ),
  Modification = c("Activating" = "#ffd92f", "Repressing" = "#655aa5")
)

rownames(annotation_col) <- c("H3K4me3 Naive T-Cell 1 " ,  " H3K4me3 Naive T-Cell 2"  , " H3K4me3 Naive T-Cell 3","H3K4me3 Naive T-Cell 4" ,  " H3K4me3 Memory T-Cell 1" , "H3K4me3 Memory T-Cell 2","H3K4me3 Memory T-Cell 3 ","H3K4me3 Memory T-Cell 4","H3K27ac Naive T-Cell 1","H3K27ac Naive T-Cell 2","H3K27ac Naive T-Cell 3","H3K27ac Naive T-Cell 4","H3K27ac Memory T-Cell 1","H3K27ac Memory T-Cell 2","H3K27ac Memory T-Cell 3 ","H3K27ac Memory T-Cell 4","H3K27me3 Naive T-Cell 1","H3K27me3 Naive T-Cell 2","H3K27me3 Naive T-Cell 3","H3K27me3 Naive T-Cell 4","H3K27me3 Memory T-Cell 1","H3K27me3 Memory T-Cell 2","H3K27me3 Memory T-Cell 3 ","H3K27me3 Memory T-Cell 4","H3K9me3 Naive T-Cell 1","H3K9me3 Naive T-Cell 2","H3K9me3 Naive T-Cell 3","H3K9me3 Naive T-Cell 4","H3K9me3 Memory T-Cell 1","H3K9me3 Memory T-Cell 2","H3K9me3 Memory T-Cell 3 ","H3K9me3 Memory T-Cell 4")


```

```{r, fig.cap="Visualisation of Top 10000 most differently expressed hPMTs across all cell types and hPMTs"}
top_rows <- head(order(apply(combined_scaled, 1, var), decreasing = TRUE), 5000)



pheatmap(combined_scaled[top_rows, ],
         annotation_col = annotation_col,
         annotation_colors = annotation_colors,
         show_colnames = FALSE,
         show_rownames = FALSE,
         main = "Scaled Signal Intensity Across hPMTs and Cell Types",
         cluster_rows = TRUE,
         breaks = my_breaks,
         cluster_cols = F)

rm(top_rows, scaled_filled)
```

In this part we are determining which rows have a lot of signal in the activating histone modification and which regions have a lot of signal in the repressing histone modification. 

Lots of signal in open chormatin regions
```{r}
# Extract memory signals by mark
mem_H3K4me3  <- combined_scaled[, 5:8]
mem_H3K27ac  <- combined_scaled[, 13:16]
mem_H3K27me3 <- combined_scaled[, 21:24]
mem_H3K9me3  <- combined_scaled[, 29:32]

# Logical checks per row:
# 1) H3K4me3 AND H3K27ac lots of signal (≥0) in any memory sample
open_high_H3K4me3  <- apply(mem_H3K4me3, 1, function(x) all(x >= 0))
open_high_H3K27ac  <- apply(mem_H3K27ac, 1, function(x) all(x >= 0))

# 2) H3K27me3 AND H3K9me3 low signal (≤0) in any memory sample
closed_low_H3K27me3 <- apply(mem_H3K27me3, 1, function(x) all(x <= 0))
closed_low_H3K9me3  <- apply(mem_H3K9me3, 1, function(x) all(x <= 0))

# Combine conditions: BOTH marks up AND BOTH marks down per row
select_rows <- which((open_high_H3K4me3 & open_high_H3K27ac) & (closed_low_H3K27me3 & closed_low_H3K9me3))

# Filtered memory subset for these rows, all memory columns
memory_activating <- combined_scaled[select_rows, c(5:8, 13:16, 21:24, 29:32)]

# Exclude rows that contain any zero in these memory columns
memory_activating <- memory_activating[!apply(memory_activating == 0, 1, any), ]

# Check dimensions and rownames
dim(memory_activating)


write.csv(memory_activating, file = "files/memory_open_peaks_signal.csv", row.names = T)
```

```{r}
# 1) H3K4me3 AND H3K27ac lots of signal (≥0) in any memory sample
open_low_H3K4me3  <- apply(mem_H3K4me3, 1, function(x) all(x <= 0))
open_low_H3K27ac  <- apply(mem_H3K27ac, 1, function(x) all(x <= 0))

# 2) H3K27me3 AND H3K9me3 low signal (≤0) in any memory sample
closed_high_H3K27me3 <- apply(mem_H3K27me3, 1, function(x) all(x >= 0))
closed_high_H3K9me3  <- apply(mem_H3K9me3, 1, function(x) all(x >= 0))

# Combine conditions: BOTH marks up AND BOTH marks down per row
select_rows_rep <- which((open_low_H3K4me3 & open_low_H3K27ac) & (closed_high_H3K27me3 & closed_high_H3K9me3))

# Filtered memory subset for these rows, all memory columns
memory_repressing <- combined_scaled[select_rows_rep, c(5:8, 13:16, 21:24, 29:32)]

# Exclude rows that contain any zero in these memory columns
memory_repressing <- memory_repressing[!apply(memory_repressing == 0, 1, any), ]

# Check dimensions and rownames
dim(memory_repressing)

write.csv(memory_repressing, file= "files/memory_closed_peaks_signal.csv", row.names = T)
```

From now on I want to look at the rows that I definded in memory_activating and memory_repressing to be up or low signal respectively in memory cells. furthermore, these peaks are present in all of the hPMTs. Using this intersection we can represent regions with coordinated chromatin changes.
```{r}
# Extract memory signals by mark
mem_H3K4me3  <- combined_scaled[, 5:8]
mem_H3K27me3 <- combined_scaled[, 21:24]

# Logical checks per row:
# 1) H3K4me3 AND H3K27ac lots of signal (≥0) in any memory sample
open_high_H3K4me3  <- apply(mem_H3K4me3, 1, function(x) all(x >= 0))

# 2) H3K27me3 AND H3K9me3 low signal (≤0) in any memory sample
closed_high_H3K27me3 <- apply(mem_H3K27me3, 1, function(x) all(x >= 0))

# Combine conditions: BOTH marks up AND BOTH marks down per row
select_rows_b <- which(open_high_H3K4me3 & closed_high_H3K27me3)

memory_bivalent <- combined_scaled[select_rows_b, c(5:8, 13:16, 21:24, 29:32)]

# Exclude rows that contain any zero in these memory columns
memory_bivalent <- memory_bivalent[!apply(memory_bivalent == 0, 1, any), ]

# Check dimensions and rownames
dim(memory_bivalent)


write.csv(memory_bivalent, file = "files/memory_bivalent.csv", row.names = T)


rm(mem_H3K9me3, mem_H3K27me3, mem_H3K27ac, mem_H3K4me3)
```
Using this approach we decrease the size of the dataset for comparing naive and memory T cells to 308 peaks, which is substantially less than the initial 45174 peaks we looked at.


```{r, warning=T, include = F, eval=F}
rm(mean_naive_H3K27ac, mean_memory_H3K27ac, mean_naive_H3K27me3, mean_memory_H3K27me3,mean_naive_H3K4me3, mean_memory_H3K4me3, mean_naive_H3K9me3, mean_memory_H3K9me3, pseudocount, H3K27ac_df, H3K27me3_df, H3K4me3_df, H3K9me3_signal,H3K27ac_signal, H3K27me3_signal, H3K4me3_signal, , sig_H3K27ac_signal, sig_H3K27me3_signal, sig_H3K4me3_signal, sig_H3K9me3_signal, closed_H3K27ac, closed_H3K27me3, closed_H3K4me3, closed_H3K9me3, open_H3K27ac, open_H3K27me3, open_H3K4me3, open_H3K9me3, sig_rows_H3K27ac, sig_rows_H3K27me3, sig_rows_H3K4me3, sig_rows_H3K9me3, log2_H3K27ac, log2_H3K27me3, log2_H3K4me3, log2_H3K9me3)
```

# Visualisation of heatmaps for memory vs exhausted
```{r}
# Suppose you have 4 naive and 4 memory samples per histone mark
annotation_col <- data.frame(
  CellType = rep(c("Memory T-Cell", "Exhausted T-Cell"), each = 4)
)

annotation_colors <- list(
  CellType = c("Memory T-Cell" = "#ff7f0e", "Exhausted T-Cell" = "#a6cee3" ))

my_breaks <- seq(-2, 2, length.out = 50)

rownames(annotation_col) <- colnames(scaled_signal_H3K4me3_exh_me)  

hmap5 <- pheatmap::pheatmap(scaled_signal_H3K4me3_exh_me, annotation_col = annotation_col, annotation_colors = annotation_colors, show_colnames = FALSE, show_rownames = FALSE, main = "H3K4me3" ,silent = TRUE)



rownames(annotation_col) <- colnames(scaled_signal_H3K27ac_exh_me)  

hmap6 <- pheatmap::pheatmap(scaled_signal_H3K27ac_exh_me, annotation_col = annotation_col, annotation_colors = annotation_colors,show_colnames = FALSE, show_rownames = FALSE, main = "H3K27ac", silent = TRUE)


rownames(annotation_col) <- colnames(scaled_signal_H3K27me3_exh_me)  
hmap7 <- pheatmap::pheatmap(scaled_signal_H3K27me3_exh_me, annotation_col = annotation_col, annotation_colors = annotation_colors,show_colnames = FALSE, show_rownames = FALSE, main = "H3K27me3", silent = TRUE)

rownames(annotation_col) <- colnames(scaled_signal_H3K9me3_exh_me)  
hmap8 <- pheatmap::pheatmap(scaled_signal_H3K9me3_exh_me, annotation_col = annotation_col, annotation_colors = annotation_colors, show_colnames = FALSE, show_rownames = FALSE, main = "H3K9me3", silent = TRUE)
```


```{r, fig.align='center',fig.cap="Figure 2. Heatmaps of z-scored signal intensities for significantly different peaks in each histone modification. Each heatmap displays naive and memory T cell samples, with hierarchical clustering of regions. Color scale represents scaled signal intensity (blue: low, yellow: intermediate, red: high", fig.height=10, fig.width= 5}
# Arrange in 2x2 grid (activating on top, suppressing on bottom)
grid.arrange(
  hmap6$gtable, hmap5$gtable,
  hmap7$gtable, hmap8$gtable,
  nrow = 4,
  top = "Histone Modification Profiles in Memory T-Cells vs Exhausted T-Cells"
)


```


```{r}
# List of all scaled matrices
scaled_list_exh_me <- list(scaled_signal_H3K4me3_exh_me, scaled_signal_H3K27ac_exh_me, scaled_signal_H3K27me3_exh_me, scaled_signal_H3K9me3_exh_me)

rm(scaled_signal_H3K4me3_exh_me, scaled_signal_H3K27ac_exh_me, scaled_signal_H3K27me3_exh_me, scaled_signal_H3K9me3_exh_me)

# Get union of all rownames (regions)
all_regions_exh_me <- Reduce(union, lapply(scaled_list_exh_me, rownames))

# Function to add missing rows with zeros and reorder rows by all_regions
fill_missing_rows <- function(mat, all_rows) {
  missing <- setdiff(all_rows, rownames(mat))
  if(length(missing) > 0) {
    # Create zero matrix for missing rows
    zero_mat <- matrix(0, nrow = length(missing), ncol = ncol(mat),
                       dimnames = list(missing, colnames(mat)))
    # Bind existing matrix and zero rows
    mat <- rbind(mat, zero_mat)
  }
  # Reorder rows
  mat[all_rows, , drop = FALSE]
}

# Apply function to each scaled matrix
scaled_filled_exh_me <- lapply(scaled_list_exh_me, fill_missing_rows, all_rows = all_regions_exh_me)

# Combine all columns together (all samples from all histone mods)
combined_scaled_exh_me <- do.call(cbind, scaled_filled_exh_me)

```

```{r}
# Get colnames for each scaled matrix (samples)
samples_H3K4me3  <- colnames(scaled_filled_exh_me[[1]])
samples_H3K27ac  <- colnames(scaled_filled_exh_me[[2]])
samples_H3K27me3 <- colnames(scaled_filled_exh_me[[3]])
samples_H3K9me3  <- colnames(scaled_filled_exh_me[[4]])

all_samples_exh_me <- c (samples_H3K27ac, samples_H3K4me3, samples_H3K27me3, samples_H3K9me3)


# Assuming 4 naive + 4 memory per histone modification, adjust if different
annotation_col <- data.frame(
  CellType = rep(c("Memory T-Cell", "Exhausted T-Cell"), times = c(4,4)),
  HistoneMark = rep(c( "H3K27ac", "H3K4me3", "H3K27me3", "H3K9me3"), each = 8),
  Modification = rep(c("Activating", "Repressing"), each = 16)
)

annotation_colors <- list(
  CellType = c("Memory T-Cell" = "#ff7f0e", "Exhausted T-Cell" = "#a6cee3"),
  HistoneMark = c(
    "H3K4me3" = "#4daf4a",
    "H3K27ac" = "#377eb8",
    "H3K27me3" = "#e41a1c",
    "H3K9me3" = "#984ea3"
  ),
  Modification = c("Activating" = "#ffd92f", "Repressing" = "#655aa5"
  )
)

rownames(annotation_col) <- c("H3K4me3 Memory T-Cell 1 " ,  " H3K4me3 Memory T-Cell 2"  , " H3K4me3 Memory T-Cell 3","H3K4me3 Memory T-Cell 4" ,  " H3K4me3 Exhausted T-Cell 1" , "H3K4me3 Exhausted T-Cell 2","H3K4me3 Exhausted T-Cell 3 ","H3K4me3 Exhausted T-Cell 4","H3K27ac Memory T-Cell 1","H3K27ac Memory T-Cell 2","H3K27ac Memory T-Cell 3","H3K27ac Memory T-Cell 4","H3K27ac Exhausted T-Cell 1","H3K27ac Exhausted T-Cell 2","H3K27ac Exhausted T-Cell 3 ","H3K27ac Exhausted T-Cell 4","H3K27me3 Memory T-Cell 1","H3K27me3 Memory T-Cell 2","H3K27me3 Memory T-Cell 3","H3K27me3 Memory T-Cell 4","H3K27me3 Exhausted T-Cell 1","H3K27me3 Exhausted T-Cell 2","H3K27me3 Exhausted T-Cell 3 ","H3K27me3 Exhausted T-Cell 4","H3K9me3 Memory T-Cell 1","H3K9me3 Memory T-Cell 2","H3K9me3 Memory T-Cell 3","H3K9me3 Memory T-Cell 4","H3K9me3 Exhausted T-Cell 1","H3K9me3 Exhausted T-Cell 2","H3K9me3 Exhausted T-Cell 3 ","H3K9me3 Exhausted T-Cell 4")


```

```{r, fig.cap="Visualisation of Top 10000 most differently expressed hPMTs across all cell types and hPMTs"}
top_rows <- head(order(apply(combined_scaled_exh_me, 1, var), decreasing = TRUE), 10000)



pheatmap(combined_scaled_exh_me[top_rows, ],
         annotation_col = annotation_col,
         annotation_colors = annotation_colors,
         show_colnames = FALSE,
         show_rownames = FALSE,
         main = "Scaled Signal Intensity Across hPMTs and Cell Types",
         cluster_rows = TRUE,
         breaks = my_breaks,
         cluster_cols = F)

rm(top_rows, scaled_filled_exh_me)
```

In this part we are determining which rows have a lot of signal in the activating histone modification and which regions have a lot of signal in the repressing histone modification. 

Lots of signal in open chormatin regions
```{r}
# Extract memory signals by mark
mem_H3K4me3_exh_me  <- combined_scaled_exh_me[, 5:8]
mem_H3K27ac_exh_me  <- combined_scaled_exh_me[, 13:16]
mem_H3K27me3_exh_me <- combined_scaled_exh_me[, 21:24]
mem_H3K9me3_exh_me  <- combined_scaled_exh_me[, 29:32]

open_high_H3K4me3_exh_me  <- apply(mem_H3K4me3_exh_me, 1, function(x) all(x >= 0))
open_high_H3K27ac_exh_me  <- apply(mem_H3K27ac_exh_me, 1, function(x) all(x >= 0))

#closed_low_H3K27me3_exh_me <- apply(mem_H3K27me3_exh_me, 1, function(x) all(x <= 0))
#closed_low_H3K9me3_exh_me  <- apply(mem_H3K9me3_exh_me, 1, function(x) all(x <= 0))

# High signal for the activating hPMTS
select_rows_exh_me <- which(open_high_H3K4me3_exh_me & open_high_H3K27ac_exh_me) 

# Filtered memory subset for these rows, all memory columns
activating_exh_me <- combined_scaled_exh_me[select_rows_exh_me, c(5:8, 13:16, 21:24, 29:32)]

# Exclude rows that contain any zero in these memory columns
activating_exh_me <- activating_exh_me[!apply(activating_exh_me == 0, 1, any), ]

# Check dimensions and rownames
dim(activating_exh_me)


write.csv(activating_exh_me, file = "files/open_peaks_signal_exh_me.csv", row.names = T)
```

```{r}
#open_low_H3K4me3_exh_me  <- apply(mem_H3K4me3_exh_me, 1, function(x) all(x <= 0))
#open_low_H3K27ac_exh_me  <- apply(mem_H3K27ac_exh_me, 1, function(x) all(x <= 0))

closed_high_H3K27me3_exh_me <- apply(mem_H3K27me3_exh_me, 1, function(x) all(x >= 0))
closed_high_H3K9me3_exh_me  <- apply(mem_H3K9me3_exh_me, 1, function(x) all(x >= 0))

# High signal for the repressing hPMTS
select_rows_rep_exh_me <- which(closed_high_H3K27me3_exh_me & closed_high_H3K9me3_exh_me) #(open_low_H3K4me3_exh_me & open_low_H3K27ac_exh_me)

# Filtered memory subset for these rows, all memory columns
repressing_exh_me <- combined_scaled_exh_me[select_rows_rep_exh_me, c(5:8, 13:16, 21:24, 29:32)]

# Exclude rows that contain any zero in these memory columns
repressing_exh_me <- repressing_exh_me[!apply(repressing_exh_me == 0, 1, any), ]

# Check dimensions and rownames
dim(repressing_exh_me)

write.csv(repressing_exh_me, file= "files/closed_peaks_signal_exh_me.csv", row.names = T)
```


```{r}
select_rows_b_exh_me <- which(open_high_H3K4me3_exh_me & closed_high_H3K27me3_exh_me)
bivalent_exh_me <- combined_scaled_exh_me[select_rows_b_exh_me, c(5:8, 13:16, 21:24, 29:32)]
bivalent_exh_me <- bivalent_exh_me[!apply(bivalent_exh_me == 0, 1, any), ]

dim(bivalent_exh_me)

write.csv(bivalent_exh_me, file = "files/bivalent_exh_me.csv", row.names = T)
rm(mem_H3K9me3_exh_me, mem_H3K27me3_exh_me, mem_H3K27ac_exh_me, mem_H3K4me3_exh_me)
```

